{% extends "layout.html" %}

{% block title %}Crop Analysis - HarvestIQ{% endblock %}

{% block content %}
<style>
    .analysis-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: calc(100vh - 80px);
        padding: 40px 20px;
        background: url("{{ url_for('static', filename='css/solution.jpg') }}") no-repeat center center/cover;
        background-size: cover;
        position: relative;
        animation: zoomBackground 30s ease-in-out infinite alternate;
    }

    .analysis-wrapper::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 0;
    }

    @keyframes zoomBackground {
        from {
            background-size: 100%;
        }

        to {
            background-size: 110%;
        }
    }

    .analysis-container {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px 40px;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 600px;
        position: relative;
        z-index: 1;
        opacity: 0;
        transform: translateY(30px);
        animation: fadeUp 1.5s ease-out forwards;
    }

    @keyframes fadeUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .analysis-container h1 {
        text-align: center;
        color: #28a745;
        margin-bottom: 30px;
        font-size: 2rem;
        animation: fadeIn 2s ease-in;
    }

    .form-section {
        margin-bottom: 20px;
    }

    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-row .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .form-group input[type="number"],
    .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        outline: none;
        transition: all 0.3s ease;
        font-size: 1rem;
        background: #f8f9fa;
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
        border-color: #28a745;
        background: #fff;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.2);
        transform: translateY(-2px);
    }

    .help-tip {
        display: inline-block;
        color: #28a745;
        background: #e8f5e8;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        text-align: center;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: help;
        margin-left: 5px;
        line-height: 18px;
        border: 1px solid #28a745;
    }

    .recommend-btn {
        width: 100%;
        margin-top: 20px;
        padding: 15px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .recommend-btn:hover {
        background: linear-gradient(135deg, #218838, #1c7b78);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    /* Results Modal */
    .result-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .result-card {
        background: #fff;
        border-radius: 20px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.5s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.7) translateY(50px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .result-card h2 {
        color: #28a745;
        margin-bottom: 20px;
        font-size: 1.8rem;
    }

    .main-recommendation {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        font-size: 1.3rem;
        font-weight: bold;
        text-transform: capitalize;
    }

    .confidence-score {
        font-size: 0.9rem;
        margin-top: 10px;
        opacity: 0.9;
    }

    .other-recommendations {
        margin-top: 25px;
    }

    .other-recommendations h3 {
        color: #333;
        margin-bottom: 15px;
    }

    .recommendation-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .recommendation-list li {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        margin: 8px 0;
        border-left: 4px solid #28a745;
        text-align: left;
        font-weight: 500;
        text-transform: capitalize;
    }

    .new-analysis-btn {
        margin-top: 25px;
        padding: 12px 25px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s ease;
    }

    .new-analysis-btn:hover {
        background: #5a6268;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 0;
        }

        .analysis-container {
            margin: 20px 10px;
            padding: 20px;
        }
    }
</style>

<div class="analysis-wrapper">
    <div class="analysis-container">
        <h1>AI Crop Analysis</h1>
        <p style="text-align: center; color: #666; margin-bottom: 25px;">
            Get personalized crop recommendations based on your soil and weather conditions
        </p>

        <form id="crop-analysis-form">
            <div class="form-section">
                <h3 style="color: #28a745; margin-bottom: 15px;">Soil Nutrients (mg/kg)</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label for="N">Nitrogen (N) <span class="help-tip"
                                title="Enter Nitrogen content in soil (mg/kg)">?</span></label>
                        <input type="number" id="N" placeholder="e.g., 90" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="P">Phosphorus (P) <span class="help-tip"
                                title="Enter Phosphorus content in soil (mg/kg)">?</span></label>
                        <input type="number" id="P" placeholder="e.g., 42" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="K">Potassium (K) <span class="help-tip"
                                title="Enter Potassium content in soil (mg/kg)">?</span></label>
                        <input type="number" id="K" placeholder="e.g., 43" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="ph">Soil pH <span class="help-tip"
                                title="Enter soil pH (usually 4.0 - 9.0)">?</span></label>
                        <input type="number" id="ph" placeholder="e.g., 6.5" step="0.1" min="3" max="9.5" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 style="color: #28a745; margin-bottom: 15px;">Weather Conditions</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label for="temperature">Temperature (Â°C)</label>
                        <input type="number" id="temperature" placeholder="e.g., 25.5" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="humidity">Humidity (%)</label>
                        <input type="number" id="humidity" placeholder="e.g., 80" step="0.1" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="rainfall">Rainfall (mm)</label>
                        <input type="number" id="rainfall" placeholder="e.g., 200" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="soil_type">Soil Type</label>
                        <select id="soil_type" required>
                            <option value="" disabled selected>Select Soil Type</option>
                            <option value="sandy">Sandy</option>
                            <option value="clay">Clay</option>
                            <option value="loamy">Loamy</option>
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit" class="recommend-btn">Analyze & Recommend Crops</button>
        </form>
    </div>
</div>

<!-- Results Modal -->
<div id="result-modal" class="result-modal">
    <div class="result-card">
        <h2>Your Crop Recommendations</h2>
        <div class="main-recommendation" id="main-recommendation">
            <!-- Main recommendation will appear here -->
        </div>

        <div class="other-recommendations">
            <h3>Other Suitable Crops:</h3>
            <ul class="recommendation-list" id="other-crops-list">
                <!-- Other recommendations will appear here -->
            </ul>
        </div>

        <button class="new-analysis-btn" onclick="closeModal()">Try New Analysis</button>
    </div>
</div>

<script>
    const form = document.getElementById('crop-analysis-form');
    const modal = document.getElementById('result-modal');
    const mainRecommendation = document.getElementById('main-recommendation');
    const otherCropsList = document.getElementById('other-crops-list');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get form data
        const formData = {
            N: document.getElementById('N').value,
            P: document.getElementById('P').value,
            K: document.getElementById('K').value,
            temperature: document.getElementById('temperature').value,
            humidity: document.getElementById('humidity').value,
            ph: document.getElementById('ph').value,
            rainfall: document.getElementById('rainfall').value,
            soil_type: document.getElementById('soil_type').value
        };

        // Validate all fields
        if (!formData.soil_type) {
            alert('Please select a soil type.');
            return;
        }

        try {
            // Show loading state
            const submitBtn = document.querySelector('.recommend-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Analyzing...';
            submitBtn.disabled = true;

            let weatherFile = ""
            try {
                weatherFile = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city.value}&appid=746ea7e0035361e7f0b9e383080eb095`);
            } catch (error) {
                console.log(error);
                alert("Can't get the details!!!")
            }

            let weatherData = await weatherFile.json();

            // if(!formData.temperature)
            console.log("Temperature : ",weatherData.Math.floor(weatherData.main.temp - 273.15))
            console.log("Humidity : ",weatherData.main.humidity)
            console.log("Humidity : ",weatherData.main.humidity)

            const response = await fetch('/recommend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }

            const data = await response.json();

            // Display results
            displayResults(data);

            // Reset button
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;

        } catch (error) {
            alert('Error getting recommendation: ' + error.message);
            // Reset button
            const submitBtn = document.querySelector('.recommend-btn');
            submitBtn.textContent = 'Analyze & Recommend Crops';
            submitBtn.disabled = false;
        }
    });

    function displayResults(data) {
        // Main recommendation
        mainRecommendation.innerHTML = `
            <div>Recommended: ${data.recommended_crop}</div>
            <div class="confidence-score">Confidence: ${data.confidence}%</div>
        `;

        // Other recommendations
        otherCropsList.innerHTML = '';
        if (data.top_recommendations) {
            data.top_recommendations.slice(1).forEach(rec => {
                const li = document.createElement('li');
                li.innerHTML = `${rec.crop} <small>(${rec.confidence}% match)</small>`;
                otherCropsList.appendChild(li);
            });
        }

        // Show modal
        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
        form.reset();
    }

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
</script>

{% endblock %}